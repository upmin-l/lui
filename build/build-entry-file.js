const path = require('path');
const fs = require('fs');

const renderString = require('json-templater/string');
const upperCamelcase = require('uppercamelcase')

const components = require('../components.json')

const IMPORT_TEMPLATE = 'import {{name}} from \'../src/packages/{{package}}/index.js\';'
const endOfLine = require('os').EOL;
const OUTPUT_PATH = path.join(__dirname, '../src/index.js');
const chalk = require('chalk')
const MAIN_TEMPLATE = ` /* Automatically generated by './build/bin/build-entry.js' */
{{filePath}}
const components = [
    {{install}}
]
const install = function (Vue) {
    components.map(v => {
        Vue.use(v)
    })
}
export{
  {{install}}
}
export default install
`
const ComponentNames = Object.keys(components);
const includeComponentTemplate = [];
const installTemplate = [];
ComponentNames.forEach(item => {
    let componentName = upperCamelcase(item);
    includeComponentTemplate.push(renderString(IMPORT_TEMPLATE, {
        name: componentName,
        package: item
    }))
    installTemplate.push(renderString('{{name}}', {
        name: componentName,
        component: item
    }))
})

const template = renderString(MAIN_TEMPLATE, {
    filePath: includeComponentTemplate.join(endOfLine),
    install: installTemplate.join(',' + endOfLine)
})
fs.writeFile(OUTPUT_PATH, template, (err) => {
    if (err) {
        console.log(chalk.red(`================================================`))
        console.log(chalk.red(`=  ${err} =`))
        console.log(chalk.red(`================================================`))
        return
    }
    console.log(chalk.green(`================================================`))
    console.log(chalk.green(`=   生成组件入口文件成功(build files success)! =`))
    console.log(chalk.green(`================================================`))
});

